
// Audience Emotion Map - Consumer Psychology Analysis
export const analyzeEmotionalJourney = async (
    input: AudienceEmotionMapInput,
    onProgress?: (message: string) => void
): Promise<AudienceEmotionMapResult | null> => {
    try {
        onProgress?.('ƒêang ph√¢n t√≠ch h√†nh tr√¨nh c·∫£m x√∫c...');

        const systemPrompt = `B·∫°n l√† Senior Consumer Psychologist chuy√™n v·ªÅ Plutchik's Wheel of Emotions.

NHI·ªÜM V·ª§: Ph√¢n t√≠ch h√†nh tr√¨nh c·∫£m x√∫c c·ªßa kh√°ch h√†ng qua 4 giai ƒëo·∫°n mua h√†ng.

NG√ÄNH H√ÄNG: ${input.industry}
${input.productCategory ? `DANH M·ª§C S·∫¢N PH·∫®M: ${input.productCategory}` : ''}
${input.targetAudience ? `ƒê·ªêI T∆Ø·ª¢NG KH√ÅCH H√ÄNG: ${input.targetAudience}` : ''}

FRAMEWORK: Plutchik's Wheel of Emotions
- 8 c·∫£m x√∫c c∆° b·∫£n: Joy, Trust, Fear, Surprise, Sadness, Disgust, Anger, Anticipation
- M·ªói c·∫£m x√∫c c√≥ 3 m·ª©c ƒë·ªô: Mild ‚Üí Moderate ‚Üí Intense

4 GIAI ƒêO·∫†N B·∫ÆT BU·ªòC (PH·∫¢I TR·∫¢ V·ªÄ ƒê·ª¶ 4):

1. AWARENESS (Nh·∫≠n bi·∫øt)
   - T√¢m l√Ω: Insecurity & Curiosity
   - C·∫£m x√∫c ph·ªï bi·∫øn: Anxiety (Lo l·∫Øng), Shame (X·∫•u h·ªï), Curiosity (T√≤ m√≤), Envy (Ghen t·ªã)
   - Brand Role: Empathizer (Ng∆∞·ªùi ƒë·ªìng c·∫£m)
   - Intensity Score: 6-8/10
   - Emoji: ü§î

2. JOURNEY (C√¢n nh·∫Øc/T√¨m hi·ªÉu)
   - T√¢m l√Ω: Overwhelm & Skepticism
   - C·∫£m x√∫c ph·ªï bi·∫øn: Confusion (B·ªëi r·ªëi), Doubt (Nghi ng·ªù), Overwhelmed (Cho√°ng ng·ª£p)
   - Brand Role: Guide (Chuy√™n gia d·∫´n d·∫Øt)
   - Intensity Score: 7-9/10
   - Emoji: ü§Ø

3. BUY (Mua h√†ng)
   - T√¢m l√Ω: Fear of Loss vs. Hope
   - C·∫£m x√∫c ph·ªï bi·∫øn: Tension (CƒÉng th·∫≥ng), Anxiety (Lo l·∫Øng) ‚Üí Relief (Nh·∫π nh√µm), Excitement (H√†o h·ª©ng)
   - Brand Role: Guarantor (Ng∆∞·ªùi b·∫£o l√£nh)
   - Intensity Score: 7-8/10
   - Emoji: üò¨

4. LOYAL (Trung th√†nh)
   - T√¢m l√Ω: Pride & Belonging
   - C·∫£m x√∫c ph·ªï bi·∫øn: Pride (T·ª± h√†o), Belonging (Thu·ªôc v·ªÅ), Joy (Vui v·∫ª)
   - Brand Role: Partner (Ng∆∞·ªùi tri k·ª∑)
   - Intensity Score: 9-10/10
   - Emoji: üòé

Y√äU C·∫¶U CHO M·ªñI GIAI ƒêO·∫†N:

1. **trigger**: T√¨nh hu·ªëng c·ª• th·ªÉ k√≠ch ho·∫°t c·∫£m x√∫c (VD: "Nh√¨n th·∫•y b·∫°n b√® ƒëƒÉng ·∫£nh du l·ªãch tr√™n Instagram")

2. **internal_monologue**: ƒê·ªôc tho·∫°i n·ªôi t√¢m c·ªßa kh√°ch h√†ng (VD: "T·∫°i sao m√¨nh ch∆∞a ƒëi ƒë√¢u c·∫£ nƒÉm nay?")

3. **recommended_tone**: Gi·ªçng vƒÉn ph√π h·ª£p (VD: "Inspirational", "Educational", "Reassuring", "Celebrating")

4. **content_hook**: V√≠ d·ª• content c·ª• th·ªÉ cho giai ƒëo·∫°n n√†y (VD: "5 ƒëi·ªÉm ƒë·∫øn chill ch·ªâ 2 tri·ªáu cho ng∆∞·ªùi l·∫ßn ƒë·∫ßu ƒëi du l·ªãch")

5. **keywords_to_use**: 3-5 t·ª´ kh√≥a/c·ª•m t·ª´ N√äN D√ôNG trong content (VD: ["D·ªÖ d√†ng", "An t√¢m", "Ph√π h·ª£p v·ªõi b·∫°n"])

6. **keywords_to_avoid**: 3-5 t·ª´ kh√≥a/c·ª•m t·ª´ N√äN TR√ÅNH (VD: ["Ph·ª©c t·∫°p", "R·ªßi ro", "Kh√¥ng ch·∫Øc ch·∫Øn"])

L∆ØU √ù QUAN TR·ªåNG:
- Ph√¢n t√≠ch ph·∫£i d·ª±a tr√™n t√¢m l√Ω th·ª±c t·∫ø c·ªßa ng√†nh h√†ng c·ª• th·ªÉ
- Intensity score ph·∫£i h·ª£p l√Ω v·ªõi t·ª´ng giai ƒëo·∫°n
- C·∫£m x√∫c ph·∫£i ph√π h·ª£p v·ªõi Plutchik's framework
- Keywords ph·∫£i th·ª±c t·∫ø v√† c√≥ th·ªÉ √°p d·ª•ng ngay

TR·∫¢ V·ªÄ JSON (ch·ªâ JSON, kh√¥ng markdown):
{
  "industry": "string",
  "emotion_journey": [
    {
      "stage": "Awareness" | "Journey" | "Buy" | "Loyal",
      "dominant_emotion": "string",
      "intensity_score": number (1-10),
      "trigger": "string",
      "internal_monologue": "string",
      "recommended_tone": "string",
      "content_hook": "string",
      "emoji": "string",
      "keywords_to_use": ["string"],
      "keywords_to_avoid": ["string"]
    }
  ]
}`;

        onProgress?.('ƒêang √°p d·ª•ng Plutchik\'s Wheel of Emotions...');

        const response = await ai.models.generateContent({
            model: 'gemini-2.0-flash-exp',
            contents: [{ role: 'user', parts: [{ text: systemPrompt }] }],
            config: {
                safetySettings: SAFETY_SETTINGS,
                temperature: 0.8,
                responseMimeType: 'application/json'
            }
        });

        const text = response.text?.trim();
        if (!text) return null;

        const jsonStr = text.replace(/```json|```/g, '').trim();
        const result = JSON.parse(jsonStr) as AudienceEmotionMapResult;

        // Ensure we have exactly 4 stages
        if (result.emotion_journey.length !== 4) {
            console.warn('Expected 4 emotion stages, got:', result.emotion_journey.length);
        }

        return result;
    } catch (error) {
        console.error('Audience Emotion Map Error:', error);
        return null;
    }
};
