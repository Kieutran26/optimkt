export const analyzeEmotionalJourney = async (
    input: AudienceEmotionMapInput,
    onProgress?: (message: string) => void
): Promise<AudienceEmotionMapResult | null> => {
    try {
        onProgress?.('üß† ƒêang ph√¢n t√≠ch t√¢m l√Ω kh√°ch h√†ng...');

        const systemPrompt = `### ROLE & OBJECTIVE
B·∫°n l√† m·ªôt Chuy√™n gia T√¢m l√Ω h·ªçc H√†nh vi (Behavioral Psychologist) v√† Nh√† nghi√™n c·ª©u Tr·∫£i nghi·ªám Kh√°ch h√†ng (CX Researcher). Nhi·ªám v·ª• c·ªßa b·∫°n l√† x√¢y d·ª±ng "B·∫£n ƒë·ªì C·∫£m x√∫c Kh√°ch h√†ng" (Audience Emotion Map) d·ª±a tr√™n m√¥ h√¨nh B√°nh xe c·∫£m x√∫c c·ªßa Plutchik, m√¥ t·∫£ ch√≠nh x√°c di·ªÖn bi·∫øn t√¢m l√Ω qua 4 giai ƒëo·∫°n mua h√†ng.

### INPUT DATA
- Industry: ${input.industry}
${input.productCategory ? `- Product Category: ${input.productCategory}` : ''}
${input.targetAudience ? `- Target Audience: ${input.targetAudience}` : ''}
- Key Pain Point/Need: ${input.painPoint}
${input.positioning ? `- Brand Positioning: ${input.positioning}` : ''}

### EMOTIONAL LOGIC (CHAIN OF THOUGHT - PLUTCHIK'S WHEEL)
H√£y ph√¢n t√≠ch s·ª± bi·∫øn thi√™n c·∫£m x√∫c d·ª±a tr√™n logic sau:

**Giai ƒëo·∫°n 1 - Awareness (Nh·∫≠n bi·∫øt):**
- C·∫£m x√∫c b·∫Øt ngu·ªìn t·ª´ "${input.painPoint}"
- N·∫øu l√† v·∫•n ƒë·ªÅ ƒëau ƒë·ªõn (s·ª©c kh·ªèe, t√†i ch√≠nh, an to√†n) ‚Üí Lo l·∫Øng/S·ª£ h√£i (Anxiety/Fear)
- N·∫øu l√† nhu c·∫ßu gi·∫£i tr√≠/c·∫£i thi·ªán ‚Üí T√≤ m√≤/H√†o h·ª©ng (Curiosity/Anticipation)
- Intensity Score: T√πy m·ª©c ƒë·ªô nghi√™m tr·ªçng c·ªßa pain point (1-10)

**Giai ƒëo·∫°n 2 - Journey (T√¨m ki·∫øm/C√¢n nh·∫Øc):**
- Khi h·ªç t√¨m gi·∫£i ph√°p, c·∫£m x√∫c th∆∞·ªùng h·ªón lo·∫°n
- Qu√° t·∫£i th√¥ng tin ‚Üí B·ªëi r·ªëi (Confusion)
- So s√°nh nhi·ªÅu l·ª±a ch·ªçn ‚Üí Nghi ng·ªù (Skepticism)
- Intensity Score: Th∆∞·ªùng cao h∆°n Awareness v√¨ √°p l·ª±c quy·∫øt ƒë·ªãnh

**Giai ƒëo·∫°n 3 - Buy (Mua h√†ng):**
- Th·ªùi ƒëi·ªÉm xu·ªëng ti·ªÅn - c·∫£m x√∫c ph·ª©c t·∫°p nh·∫•t
${input.positioning === 'premium' ? '- Gi√° tr·ªã cao (Premium) ‚Üí CƒÉng th·∫≥ng (Stress) cao nh∆∞ng ƒëi k√®m Hy v·ªçng (Hope)' : ''}
${input.positioning === 'budget' ? '- Gi√° r·∫ª ‚Üí An t√¢m (Relief), H√†i l√≤ng (Satisfaction)' : ''}
- N·∫øu kh√¥ng c√≥ positioning info, suy lu·∫≠n d·ª±a tr√™n industry
- Intensity Score: ƒê·ªânh ƒëi·ªÉm c·ªßa h√†nh tr√¨nh (th∆∞·ªùng 7-9)

**Giai ƒëo·∫°n 4 - Loyal (Sau mua/Trung th√†nh):**
- K·∫øt qu·∫£ cu·ªëi c√πng - PH·∫¢I l√† c·∫£m x√∫c t√≠ch c·ª±c
- H√†i l√≤ng (Joy), T·ª± h√†o (Pride), Tin t∆∞·ªüng (Trust)
- Intensity Score: Gi·∫£m xu·ªëng nh∆∞ng v·∫´n t√≠ch c·ª±c (6-8)

### PLUTCHIK'S WHEEL EMOTIONS (Ch·ªâ d√πng c√°c c·∫£m x√∫c n√†y)
**Primary Emotions:**
- Joy (Vui v·∫ª), Sadness (Bu·ªìn b√£), Anger (T·ª©c gi·∫≠n), Fear (S·ª£ h√£i)
- Trust (Tin t∆∞·ªüng), Disgust (Gh√™ t·ªüm), Surprise (Ng·∫°c nhi√™n), Anticipation (Mong ƒë·ª£i)

**Secondary Emotions:**
- Anxiety (Lo √¢u), Hope (Hy v·ªçng), Relief (Nh·∫π nh√µm), Pride (T·ª± h√†o)
- Confusion (B·ªëi r·ªëi), Skepticism (Nghi ng·ªù), Excitement (Ph·∫•n kh√≠ch)

### OUTPUT FORMAT (STRICT JSON)
{
  "industry": "${input.industry}",
  "emotion_journey": [
    {
      "stage": "Awareness",
      "dominant_emotion": "Emotion Name (Ti·∫øng Vi·ªát) - VD: Anxiety (Lo √¢u)",
      "intensity_score": 1-10,
      "trigger": "ƒêi·ªÅu g√¨ k√≠ch ho·∫°t c·∫£m x√∫c n√†y (li√™n quan ƒë·∫øn ${input.painPoint})",
      "internal_monologue": "ƒê·ªôc tho·∫°i n·ªôi t√¢m c·ªßa kh√°ch h√†ng (VD: 'T√¥i lo l·∫Øng v·ªÅ...')",
      "recommended_tone": "Gi·ªçng ƒëi·ªáu th∆∞∆°ng hi·ªáu n√™n d√πng (VD: Th·∫•u hi·ªÉu, An ·ªßi)",
      "content_hook": "C√¢u hook n·ªôi dung c·ª• th·ªÉ",
      "emoji": "ü§Ø",
      "keywords_to_use": ["T·ª´ kh√≥a n√™n d√πng"],
      "keywords_to_avoid": ["T·ª´ kh√≥a n√™n tr√°nh"]
    },
    {
      "stage": "Journey",
      "dominant_emotion": "...",
      "intensity_score": ...,
      "trigger": "...",
      "internal_monologue": "...",
      "recommended_tone": "...",
      "content_hook": "...",
      "emoji": "ü§î",
      "keywords_to_use": [],
      "keywords_to_avoid": []
    },
    {
      "stage": "Buy",
      "dominant_emotion": "...",
      "intensity_score": ...,
      "emoji": "üò¨"
    },
    {
      "stage": "Loyal",
      "dominant_emotion": "...",
      "intensity_score": ...,
      "emoji": "üòé"
    }
  ]
}

### QUALITY CONTROL
- Tuy·ªát ƒë·ªëi tu√¢n th·ªß Plutchik's Wheel emotions
- N·∫øu painPoint kh√¥ng r√µ, suy lu·∫≠n d·ª±a tr√™n n·ªói ƒëau ph·ªï bi·∫øn c·ªßa ${input.industry}
- Intensity Score ph·∫£i kh·ªõp v·ªõi m·ª©c ƒë·ªô nghi√™m tr·ªçng (S·ª©c kh·ªèe/T√†i ch√≠nh > Gi·∫£i tr√≠)
- Bi·ªÉu ƒë·ªì ph·∫£i c√≥ s·ª± l√™n xu·ªëng logic, kh√¥ng ph·∫£i ƒë∆∞·ªùng th·∫≥ng
- Giai ƒëo·∫°n Loyal PH·∫¢I l√† c·∫£m x√∫c t√≠ch c·ª±c
- Output PH·∫¢I l√† JSON valid, kh√¥ng c√≥ markdown`;

        const response = await ai.models.generateContent({
            model: 'gemini-2.0-flash-exp',
            contents: `Analyze emotional journey with Plutchik's Wheel framework`,
            config: {
                systemInstruction: systemPrompt,
                responseMimeType: "application/json",
                safetySettings: SAFETY_SETTINGS,
                temperature: 0.8
            },
        });

        onProgress?.('‚ú® ƒêang ho√†n thi·ªán b·∫£n ƒë·ªì c·∫£m x√∫c...');

        const text = response.text?.trim();
        if (!text) return null;

        const jsonStr = text.replace(/```json|```/g, '').trim();
        const result = JSON.parse(jsonStr) as AudienceEmotionMapResult;

        // Ensure exactly 4 stages
        if (!result.emotion_journey || result.emotion_journey.length !== 4) {
            console.error('Invalid emotion journey structure');
            return null;
        }

        return result;
    } catch (error) {
        console.error('Emotion Map Error:', error);
        return null;
    }
};
