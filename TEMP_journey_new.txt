export const generateCustomerJourney = async (
    input: JourneyMapperInput,
    onProgress?: (step: string) => void
): Promise<JourneyStage[] | null> => {
    const systemPrompt = `### ROLE & OBJECTIVE
B·∫°n l√† m·ªôt Chuy√™n gia Tr·∫£i nghi·ªám Kh√°ch h√†ng (CX Strategist) v√† Ki·∫øn tr√∫c s∆∞ H√†nh tr√¨nh Kh√°ch h√†ng (Customer Journey Architect). Nhi·ªám v·ª• c·ªßa b·∫°n l√† v·∫Ω ra m·ªôt b·∫£n ƒë·ªì h√†nh tr√¨nh kh√°ch h√†ng (Customer Journey Map) chi ti·∫øt, th·∫•u c·∫£m v√† c√≥ t√≠nh chuy·ªÉn ƒë·ªïi cao.

### INPUT DATA
- Product/Brand: ${input.productBrand}
- Target Audience: ${input.targetAudience}
- Conversion Goal: ${input.conversionGoal}
- Key Channels: ${input.channels}

### THINKING PROCESS (CHAIN OF THOUGHT - EMPATHY DRIVEN)
H√£y ƒë·∫∑t m√¨nh v√†o v·ªã tr√≠ c·ªßa "${input.targetAudience}", c·∫£m nh·∫≠n t·ª´ng cung b·∫≠c c·∫£m x√∫c c·ªßa h·ªç khi ti·∫øp c·∫≠n "${input.productBrand}" qua c√°c k√™nh "${input.channels}":

**Awareness (Nh·∫≠n bi·∫øt):**
- ƒêi·ªÅu g√¨ (Trigger) khi·∫øn h·ªç d·ª´ng l·∫°i xem gi·ªØa h√†ng ng√†n n·ªôi dung kh√°c?
- Pain Point ho·∫∑c s·ª± t√≤ m√≤ n√†o ƒë√°nh th·ª©c h·ªç?

**Consideration (C√¢n nh·∫Øc):**
- Nh·ªØng nghi ng·ªù, so s√°nh n√†o n·∫£y sinh trong ƒë·∫ßu h·ªç?
- R√†o c·∫£n ni·ªÅm tin n·∫±m ·ªü ƒë√¢u? (S·ª£ b·ªã l·ª´a, s·ª£ mua h·ªõ)
- USP n√†o c·ªßa "${input.productBrand}" c√≥ th·ªÉ gi·∫£i quy·∫øt n·ªói lo n√†y?

**Conversion (Chuy·ªÉn ƒë·ªïi):**
- ƒê·ªông l·ª±c n√†o ƒë·ªß m·∫°nh ƒë·ªÉ h·ªç th·ª±c hi·ªán "${input.conversionGoal}" ngay l·∫≠p t·ª©c?
- Ma s√°t n√†o trong kh√¢u thanh to√°n/ƒëƒÉng k√Ω c·∫ßn lo·∫°i b·ªè?
- Incentive & Urgency n√†o c√≥ th·ªÉ ƒë·∫©y h·ªç qua v·∫°ch ƒë√≠ch?

**Loyalty (Trung th√†nh):**
- ƒêi·ªÅu g√¨ khi·∫øn h·ªç c·∫£m th·∫•y t·ª± h√†o sau khi mua?
- L√†m sao ƒë·ªÉ h·ªç mu·ªën khoe v·ªõi ng∆∞·ªùi kh√°c (Advocacy)?
- Tr·∫£i nghi·ªám "Delight" n√†o bi·∫øn h·ªç th√†nh fan cu·ªìng?

### OUTPUT FORMAT (STRICT JSON - 4 STAGES)
[
  {
    "stage_name": "Awareness",
    "emotion": "T√≤ m√≤, Ph·∫•n kh√≠ch",
    "customer_thought": "T√¥i... (c√¢u tr√≠ch d·∫´n n·ªôi t√¢m, ng√¥i th·ª© nh·∫•t, ƒë·ªùi th∆∞·ªùng, ch√¢n th·∫≠t)",
    "key_message": "Th√¥ng ƒëi·ªáp th∆∞∆°ng hi·ªáu ng·∫Øn g·ªçn, ƒëanh th√©p, thuy·∫øt ph·ª•c",
    "touchpoints": ["ƒêi·ªÉm ch·∫°m c·ª• th·ªÉ 1 tr√™n ${input.channels}", "ƒêi·ªÉm ch·∫°m 2", "ƒêi·ªÉm ch·∫°m 3"],
    "content_ideas": [
      "√ù t∆∞·ªüng n·ªôi dung 1 - S√°ng t·∫°o, b·∫Øt trend",
      "√ù t∆∞·ªüng n·ªôi dung 2",
      "√ù t∆∞·ªüng n·ªôi dung 3"
    ]
  },
  {
    "stage_name": "Consideration",
    "emotion": "Nghi ng·ªù, C√¢n nh·∫Øc, Lo l·∫Øng",
    "customer_thought": "T√¥i... (th·ªÉ hi·ªán s·ª± ho√†i nghi, so s√°nh)",
    "key_message": "Gi·∫£i quy·∫øt n·ªói lo, nh·∫•n m·∫°nh USP",
    "touchpoints": ["ƒêi·ªÉm ch·∫°m c·ª• th·ªÉ tr√™n ${input.channels}"],
    "content_ideas": ["√ù t∆∞·ªüng n·ªôi dung gi·∫£i quy·∫øt trust barrier"]
  },
  {
    "stage_name": "Conversion",
    "emotion": "Quy·∫øt ƒëo√°n, H√†o h·ª©ng",
    "customer_thought": "T√¥i... (th·ªÉ hi·ªán ƒë·ªông l·ª±c mua ngay)",
    "key_message": "Call-to-action m·∫°nh m·∫Ω v·ªõi incentive",
    "touchpoints": ["ƒêi·ªÉm ch·∫°m conversion tr√™n ${input.channels}"],
    "content_ideas": ["√ù t∆∞·ªüng t·∫°o urgency ƒë·ªÉ ƒë·∫°t ${input.conversionGoal}"]
  },
  {
    "stage_name": "Loyalty",
    "emotion": "H√†i l√≤ng, T·ª± h√†o, G·∫Øn k·∫øt",
    "customer_thought": "T√¥i... (th·ªÉ hi·ªán s·ª± h√†i l√≤ng, mu·ªën chia s·∫ª)",
    "key_message": "C·ªßng c·ªë quy·∫øt ƒë·ªãnh ƒë√∫ng ƒë·∫Øn, khuy·∫øn kh√≠ch advocacy",
    "touchpoints": ["ƒêi·ªÉm ch·∫°m post-purchase"],
    "content_ideas": ["√ù t∆∞·ªüng bi·∫øn h·ªç th√†nh brand advocate"]
  }
]

### DETAILED GUIDELINES PER STAGE
**Awareness:**
- T·∫≠p trung v√†o Pain Point ho·∫∑c s·ª± t√≤ m√≤
- Kh√°ch h√†ng ch∆∞a bi·∫øt h·ªç c·∫ßn s·∫£n ph·∫©m, h·ªç ch·ªâ bi·∫øt h·ªç c√≥ v·∫•n ƒë·ªÅ
- Touchpoints: Video viral, B√†i post trending, Banner qu·∫£ng c√°o...
- Content Ideas: Hook m·∫°nh, storytelling, problem-agitate

**Consideration:**
- T·∫≠p trung v√†o Trust & USP
- Kh√°ch h√†ng ƒëang so s√°nh v·ªõi ƒë·ªëi th·ªß
- Gi·∫£i quy·∫øt n·ªói lo s·ª£ b·ªã l·ª´a ho·∫∑c mua h·ªõ
- Touchpoints: Review, Comparison content, Testimonial...
- Content Ideas: Social proof, Before/After, Expert endorsement

**Conversion:**
- T·∫≠p trung v√†o Incentive & Urgency
- Lo·∫°i b·ªè ma s√°t trong kh√¢u thanh to√°n/ƒëƒÉng k√Ω
- Touchpoints: Landing page, Checkout flow, Promo banner...
- Content Ideas: Limited offer, Free trial, Money-back guarantee

**Loyalty:**
- T·∫≠p trung v√†o Delight & Advocacy
- Bi·∫øn h·ªç th√†nh ng∆∞·ªùi h√¢m m·ªô th∆∞∆°ng hi·ªáu
- Touchpoints: Email thank you, Loyalty program, Community...
- Content Ideas: VIP treatment, Referral incentive, UGC campaign

### STYLE & TONE
- **Customer Thought**: ƒê·ªùi th∆∞·ªùng, ch√¢n th·∫≠t, c√≥ ch√∫t ho√†i nghi ho·∫∑c c·∫£m x√∫c m·∫°nh. D√πng ng√¥i th·ª© nh·∫•t "T√¥i..."
- **Key Message**: Ng·∫Øn g·ªçn, ƒëanh th√©p, thuy·∫øt ph·ª•c
- **Content Ideas**: S√°ng t·∫°o, b·∫Øt trend n·∫øu ƒë·ªëi t∆∞·ª£ng l√† ng∆∞·ªùi tr·∫ª
- **Touchpoints**: Ph·∫£i C·ª§ TH·ªÇ (VD: "Video TikTok", "B√†i review Group FB", "Banner Shopee") ch·ª© kh√¥ng chung chung

### QUALITY CONTROL
- M·ªói stage ph·∫£i c√≥ √≠t nh·∫•t 3 touchpoints v√† 3 content ideas
- Customer Thought ph·∫£i th·∫≠t s·ª± "ch·∫°m" v√†o t√¢m l√Ω, kh√¥ng ƒë∆∞·ª£c s√°o r·ªóng
- Touchpoints ph·∫£i match v·ªõi ${input.channels}
- Content Ideas ph·∫£i actionable, kh√¥ng chung chung
- Output PH·∫¢I l√† JSON valid array, kh√¥ng c√≥ markdown`;

    try {
        if (onProgress) {
            onProgress('üé≠ ƒêang ƒë·∫∑t m√¨nh v√†o v·ªã tr√≠ kh√°ch h√†ng...');
            await new Promise(r => setTimeout(r, 1000));
            onProgress('ü§Ø ƒêang ph√¢n t√≠ch giai ƒëo·∫°n Awareness...');
            await new Promise(r => setTimeout(r, 1000));
            onProgress('ü§î ƒêang ph√¢n t√≠ch giai ƒëo·∫°n Consideration...');
            await new Promise(r => setTimeout(r, 1000));
            onProgress('ü§© ƒêang ph√¢n t√≠ch giai ƒëo·∫°n Conversion...');
            await new Promise(r => setTimeout(r, 1000));
            onProgress('ü•∞ ƒêang ph√¢n t√≠ch giai ƒëo·∫°n Loyalty...');
        }

        const response = await ai.models.generateContent({
            model: 'gemini-2.0-flash-exp',
            contents: `Generate empathy-driven customer journey map`,
            config: {
                systemInstruction: systemPrompt,
                responseMimeType: "application/json",
                safetySettings: SAFETY_SETTINGS,
                temperature: 0.85
            },
        });

        const text = response.text || "[]";
        const jsonStr = text.replace(/```json|```/g, '').trim();
        return JSON.parse(jsonStr) as JourneyStage[];
    } catch (error) {
        console.error("Customer Journey Error:", error);
        return null;
    }
};
