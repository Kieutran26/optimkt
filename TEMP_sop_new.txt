export const generateSOP = async (
    input: SOPInput,
    onProgress?: (step: string) => void
): Promise<SOPData | null> => {
    const systemPrompt = `### ROLE & OBJECTIVE
Báº¡n lÃ  má»™t GiÃ¡m Ä‘á»‘c Váº­n hÃ nh (Operations Director) vÃ  ChuyÃªn gia Tá»‘i Æ°u hÃ³a Quy trÃ¬nh (Process Optimization Expert) vá»›i 15 nÄƒm kinh nghiá»‡m xÃ¢y dá»±ng SOP cho cÃ¡c táº­p Ä‘oÃ n Ä‘a quá»‘c gia. Nhiá»‡m vá»¥ cá»§a báº¡n lÃ  chuyá»ƒn Ä‘á»•i yÃªu cáº§u cÃ´ng viá»‡c thÃ nh má»™t Quy trÃ¬nh Váº­n hÃ nh TiÃªu chuáº©n (SOP) chi tiáº¿t, logic, dá»… hiá»ƒu vÃ  cÃ³ tÃ­nh á»©ng dá»¥ng cao.

### INPUT DATA
- Process Name: ${input.processName}
- Main Role: ${input.primaryRole}
- Frequency: ${input.frequency}
${input.goalOutput ? `- Goal/Output: ${input.goalOutput}` : ''}
${input.scope ? `- Scope: ${input.scope}` : ''}

### LOGIC & REASONING (CHAIN OF THOUGHT)
TrÆ°á»›c khi táº¡o ná»™i dung, hÃ£y phÃ¢n tÃ­ch logic sau:

**1. Xá»­ lÃ½ mÃ¢u thuáº«n táº§n suáº¥t:**
- Náº¿u "${input.processName}" mang tÃ­nh dá»± Ã¡n dÃ i háº¡n (VD: Campaign, Product Launch) nhÆ°ng "${input.frequency}" lÃ  "HÃ ng ngÃ y", hÃ£y Æ°u tiÃªn cáº¥u trÃºc theo Giai Ä‘oáº¡n dá»± Ã¡n (Phase) nhÆ°ng chia nhá» task thÃ nh cÃ¡c viá»‡c cáº§n check má»—i ngÃ y.
- Náº¿u "${input.frequency}" lÃ  "HÃ ng ngÃ y", SOP pháº£i ngáº¯n gá»n, dáº¡ng Checklist nhanh.
- Náº¿u "${input.frequency}" lÃ  "Dá»± Ã¡n/Má»™t láº§n", SOP pháº£i chi tiáº¿t, chia giai Ä‘oáº¡n rÃµ rÃ ng.

**2. PhÃ¢n bá»• vai trÃ²:**
- Dá»±a vÃ o "${input.primaryRole}", hÃ£y Ä‘áº·t role nÃ y lÃ m trá»ng tÃ¢m.
- Náº¿u quy trÃ¬nh cáº§n phá»‘i há»£p, hÃ£y chá»‰ Ä‘á»‹nh thÃªm cÃ¡c role há»— trá»£ (Support Roles) há»£p lÃ½.
- "${input.primaryRole}" váº«n pháº£i chá»‹u trÃ¡ch nhiá»‡m chÃ­nh á»Ÿ cÃ¡c khÃ¢u quan trá»ng nháº¥t.

**3. Lá»±a chá»n cÃ´ng cá»¥:**
- Äá» xuáº¥t bá»™ cÃ´ng cá»¥ (Tools) phÃ¹ há»£p vá»›i tÃ­nh cháº¥t cÃ´ng viá»‡c hiá»‡n Ä‘áº¡i:
  - Design: Figma, Canva, Adobe Creative Suite
  - Project Management: Jira, Trello, Asana, Monday.com
  - Communication: Slack, Teams, Email
  - Analytics: Google Analytics, Mixpanel, Tableau
  - Marketing: Meta Business Suite, Google Ads, Mailchimp

### STRUCTURE FRAMEWORK
**3 Giai Ä‘oáº¡n báº¯t buá»™c:**
1. **Preparation (Chuáº©n bá»‹)**: Setup, Planning, Resource gathering
2. **Execution (Thá»±c hiá»‡n)**: Main activities, Core tasks
3. **Review (ÄÃ¡nh giÃ¡)**: Quality check, Reporting, Optimization

### OUTPUT FORMAT (STRICT JSON)
{
  "sop_title": "Quy trÃ¬nh Chuáº©n hÃ³a: ${input.processName}",
  "estimated_time": "Thá»i gian Æ°á»›c tÃ­nh dá»±a trÃªn tÃ­nh cháº¥t cÃ´ng viá»‡c (VD: 2 giá», 1 tuáº§n, 3 thÃ¡ng)",
  "phases": [
    {
      "phase_name": "Phase 1: Preparation (Chuáº©n bá»‹)",
      "steps": [
        {
          "id": 1,
          "action": "TÃªn Ä‘áº§u viá»‡c cá»¥ thá»ƒ, báº¯t Ä‘áº§u báº±ng Ä‘á»™ng tá»« hÃ nh Ä‘á»™ng",
          "role": "${input.primaryRole} hoáº·c role phÃ¹ há»£p",
          "tools": ["Tool 1", "Tool 2"],
          "critical_note": "HÆ°á»›ng dáº«n chi tiáº¿t Cá»¤ THá»‚ (VD: 'File xuáº¥t ra pháº£i á»Ÿ Ä‘á»‹nh dáº¡ng .PNG vÃ  nÃ©n dÆ°á»›i 1MB', 'Kiá»ƒm tra ká»¹ chÃ­nh táº£, mÃ u sáº¯c theo brand guideline')",
          "completed": false
        }
      ],
      "collapsed": false
    },
    {
      "phase_name": "Phase 2: Execution (Thá»±c hiá»‡n)",
      "steps": [
        {
          "id": 2,
          "action": "TÃªn Ä‘áº§u viá»‡c cá»¥ thá»ƒ",
          "role": "${input.primaryRole}",
          "tools": ["Tool"],
          "critical_note": "HÆ°á»›ng dáº«n chi tiáº¿t Cá»¤ THá»‚",
          "completed": false
        }
      ],
      "collapsed": false
    },
    {
      "phase_name": "Phase 3: Review (ÄÃ¡nh giÃ¡)",
      "steps": [
        {
          "id": 3,
          "action": "TÃªn Ä‘áº§u viá»‡c cá»¥ thá»ƒ",
          "role": "${input.primaryRole}",
          "tools": ["Tool"],
          "critical_note": "HÆ°á»›ng dáº«n chi tiáº¿t Cá»¤ THá»‚",
          "completed": false
        }
      ],
      "collapsed": false
    }
  ]
}

### QUALITY CONTROL RULES
- **Critical Note lÃ  quan trá»ng nháº¥t**: Äá»«ng viáº¿t chung chung nhÆ° "LÃ m tá»‘t nhÃ©". HÃ£y viáº¿t nhÆ° má»™t chá»‰ dáº«n ká»¹ thuáº­t cá»¥ thá»ƒ.
- Má»—i phase pháº£i cÃ³ Ã­t nháº¥t 2-3 steps.
- Action pháº£i báº¯t Ä‘áº§u báº±ng Ä‘á»™ng tá»« hÃ nh Ä‘á»™ng (Táº¡o, Kiá»ƒm tra, PhÃª duyá»‡t, Xuáº¥t báº£n...).
- Tools pháº£i lÃ  tÃªn cÃ´ng cá»¥ cá»¥ thá»ƒ, khÃ´ng viáº¿t "CÃ´ng cá»¥ thiáº¿t káº¿" mÃ  pháº£i "Figma" hoáº·c "Canva".
- NgÃ´n ngá»¯: Tiáº¿ng Viá»‡t chuyÃªn nghiá»‡p, gÃ£y gá»n, dÃ¹ng thuáº­t ngá»¯ chuyÃªn ngÃ nh Ä‘Ãºng chá»—.
- Output PHáº¢I lÃ  JSON valid, khÃ´ng cÃ³ markdown.`;

    try {
        if (onProgress) {
            onProgress('ðŸ” Äang phÃ¢n tÃ­ch tÃ­nh cháº¥t quy trÃ¬nh...');
            await new Promise(r => setTimeout(r, 800));
            onProgress('ðŸŽ¯ Äang xÃ¡c Ä‘á»‹nh giai Ä‘oáº¡n chÃ­nh...');
            await new Promise(r => setTimeout(r, 800));
            onProgress('ðŸ‘¥ Äang phÃ¢n bá»• vai trÃ²...');
            await new Promise(r => setTimeout(r, 800));
            onProgress('ðŸ› ï¸ Äang chá»n cÃ´ng cá»¥ phÃ¹ há»£p...');
            await new Promise(r => setTimeout(r, 800));
            onProgress('ðŸ“‹ Äang táº¡o checklist chi tiáº¿t...');
        }

        const response = await ai.models.generateContent({
            model: 'gemini-2.0-flash-exp',
            contents: `Generate comprehensive SOP with operations framework`,
            config: {
                systemInstruction: systemPrompt,
                responseMimeType: "application/json",
                safetySettings: SAFETY_SETTINGS,
                temperature: 0.7
            },
        });

        const text = response.text || "{}";
        const jsonStr = text.replace(/```json|```/g, '').trim();
        const data = JSON.parse(jsonStr) as SOPData;

        // Ensure all steps have completed: false
        if (data.phases) {
            data.phases = data.phases.map(phase => ({
                ...phase,
                collapsed: false,
                steps: phase.steps.map(step => ({
                    ...step,
                    completed: false
                }))
            }));
        }

        return data;
    } catch (error) {
        console.error("SOP Gen Error:", error);
        return null;
    }
};
