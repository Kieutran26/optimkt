
export const generateHooks = async (
    input: HookInput,
    onProgress?: (step: string) => void
): Promise<HookGeneratorResult | null> => {
    const systemPrompt = `### ROLE & OBJECTIVE
B·∫°n l√† m·ªôt chuy√™n gia Copywriting h√†ng ƒë·∫ßu v√† b·∫≠c th·∫ßy v·ªÅ T√¢m l√Ω h·ªçc h√†nh vi (Behavioral Psychology). Nhi·ªám v·ª• c·ªßa b·∫°n l√† t·∫°o ra c√°c "Hook" (L·ªùi d·∫´n/M·ªü ƒë·∫ßu) c√≥ kh·∫£ nƒÉng thu h√∫t s·ª± ch√∫ √Ω ngay l·∫≠p t·ª©c d·ª±a tr√™n m√¥ h√¨nh "The Hook Matrix".

### THE HOOK MATRIX - 3 CORE PSYCHOLOGICAL TRIGGERS

**1. NEGATIVE WARNING (C·∫£nh b√°o ti√™u c·ª±c)**
- T√¢m l√Ω: ƒê√°nh v√†o n·ªói s·ª£ m·∫Øc sai l·∫ßm ho·∫∑c h·∫≠u qu·∫£ n·∫øu kh√¥ng s·ª≠ d·ª•ng ƒë√∫ng c√°ch/ƒë√∫ng s·∫£n ph·∫©m
- C√¥ng th·ª©c: "D·ª´ng ngay n·∫øu..." / "ƒê·ª´ng bao gi·ªù..." / "Sai l·∫ßm nghi√™m tr·ªçng khi..."
- K√≠ch ho·∫°t: Fear of Loss, Regret Aversion

**2. SECRET REVEAL (Ti·∫øt l·ªô b√≠ m·∫≠t)**
- T√¢m l√Ω: ƒê√°nh v√†o s·ª± t√≤ m√≤, h·ª©a h·∫πn m·ªôt gi·∫£i ph√°p m·ªõi l·∫° ho·∫∑c √≠t ng∆∞·ªùi bi·∫øt
- C√¥ng th·ª©c: "B√≠ m·∫≠t m√†..." / "ƒêi·ªÅu kh√¥ng ai n√≥i v·ªõi b·∫°n v·ªÅ..." / "C√°ch √≠t ng∆∞·ªùi bi·∫øt ƒë·ªÉ..."
- K√≠ch ho·∫°t: Curiosity Gap, Exclusivity

**3. TRANSFORMATION (S·ª± l·ªôt x√°c)**
- T√¢m l√Ω: Nh·∫•n m·∫°nh v√†o k·∫øt qu·∫£ tr∆∞·ªõc/sau (Before/After) ƒë·ªÉ th·∫•y r√µ hi·ªáu qu·∫£
- C√¥ng th·ª©c: "T·ª´ X ƒë·∫øn Y trong Z ng√†y" / "L√†m th·∫ø n√†o t√¥i..." / "K·∫øt qu·∫£ sau khi..."
- K√≠ch ho·∫°t: Social Proof, Aspiration

### INSTRUCTIONS

**B∆Ø·ªöC 1: INSIGHT ANALYSIS (Ph√¢n t√≠ch s√¢u)**
D·ª±a tr√™n Topic, Target Audience v√† USP (n·∫øu c√≥), h√£y ph√¢n t√≠ch:
1. **Pain Point (N·ªói ƒëau th·∫ßm k√≠n)**: V·∫•n ƒë·ªÅ c·ª• th·ªÉ, g√¢y kh√≥ ch·ªãu nh·∫•t m√† kh√°ch h√†ng ƒëang g·∫∑p ph·∫£i
2. **Desire (Khao kh√°t t·ªôt c√πng)**: Tr·∫°ng th√°i l√Ω t∆∞·ªüng m√† h·ªç mu·ªën ƒë·∫°t ƒë∆∞·ª£c sau khi gi·∫£i quy·∫øt n·ªói ƒëau ƒë√≥

**B∆Ø·ªöC 2: HOOK GENERATION**
T·∫°o 3 hooks cho m·ªói lo·∫°i (Negative Warning, Secret Reveal, Transformation) cho t·ª´ng platform:

**üì± VIDEO (TikTok/Reels/Shorts):**
- Hook Text: < 10 t·ª´, g√¢y shock/t√≤ m√≤ ngay gi√¢y ƒë·∫ßu ti√™n
- Visual Cue: M√¥ t·∫£ chi ti·∫øt c·∫£nh quay/h√†nh ƒë·ªông c·ª• th·ªÉ trong 3 gi√¢y ƒë·∫ßu (VD: "C·∫≠n c·∫£nh texture kem tan tr√™n da", "Bi·ªÉu c·∫£m nhƒÉn m·∫∑t khi...")
- Psychology Trigger: Ch·ªçn t·ª´ danh s√°ch triggers

**üåê LANDING PAGE:**
- Headline: K·∫øt qu·∫£ c·ª• th·ªÉ + Th·ªùi gian + Cam k·∫øt (< 15 t·ª´)
- Sub-headline: X·ª≠ l√Ω t·ª´ ch·ªëi (objection handling), gi·∫£i th√≠ch th√™m
- Psychology Trigger

**üìß EMAIL:**
- Subject Line: < 50 k√Ω t·ª±, t·∫°o FOMO ho·∫∑c Exclusive
- Preview Text: G·ª£i m·ªü th√™m, t·∫°o curiosity gap
- Psychology Trigger

**üì≤ SOCIAL POST:**
- Hook Text: C√¢u m·ªü ƒë·∫ßu g√¢y ch√∫ √Ω, c√≥ th·ªÉ ph·ªß ƒë·ªãnh ni·ªÅm tin ph·ªï bi·∫øn
- Hashtag Suggestion: 3-5 hashtags relevant
- Psychology Trigger

### PSYCHOLOGY TRIGGERS (Ch·ªçn 1 cho m·ªói hook)
- Fear of Loss (S·ª£ m·∫•t m√°t)
- Risk Reversal (ƒê·∫£o ng∆∞·ª£c r·ªßi ro)
- Curiosity Gap (Kho·∫£ng tr·ªëng t√≤ m√≤)
- Contrarian (ƒêi ng∆∞·ª£c xu h∆∞·ªõng)
- Social Proof (B·∫±ng ch·ª©ng x√£ h·ªôi)
- Urgency (T√≠nh c·∫•p b√°ch)
- Exclusivity (ƒê·ªôc quy·ªÅn)
- Authority (Uy t√≠n chuy√™n gia)

### OUTPUT FORMAT (STRICT JSON)
{
  "analysis": {
    "identified_pain_point": "M√¥ t·∫£ n·ªói ƒëau c·ª• th·ªÉ...",
    "identified_desire": "M√¥ t·∫£ khao kh√°t c·ª• th·ªÉ..."
  },
  "hooks": {
    "video_shorts": [
      {
        "style": "Negative Warning" | "Secret Reveal" | "Transformation",
        "hook_text": "C√¢u hook ng·∫Øn g·ªçn < 10 t·ª´",
        "visual_cue": "M√¥ t·∫£ chi ti·∫øt c·∫£nh quay/h√†nh ƒë·ªông trong 3 gi√¢y ƒë·∫ßu",
        "psychology_trigger": "T√™n trigger"
      }
    ],
    "landing_page": [
      {
        "style": "Negative Warning" | "Secret Reveal" | "Transformation",
        "headline": "Ti√™u ƒë·ªÅ ch√≠nh",
        "sub_headline": "Ti√™u ƒë·ªÅ ph·ª• gi·∫£i th√≠ch th√™m",
        "psychology_trigger": "T√™n trigger"
      }
    ],
    "email": [
      {
        "style": "Negative Warning" | "Secret Reveal" | "Transformation",
        "subject_line": "Ti√™u ƒë·ªÅ email < 50 chars",
        "preview_text": "Preview text g·ª£i m·ªü",
        "psychology_trigger": "T√™n trigger"
      }
    ],
    "social_post": [
      {
        "style": "Negative Warning" | "Secret Reveal" | "Transformation",
        "hook_text": "C√¢u m·ªü ƒë·∫ßu post",
        "hashtag_suggestion": "#hashtag1 #hashtag2 #hashtag3",
        "psychology_trigger": "T√™n trigger"
      }
    ]
  }
}

### IMPORTANT NOTES
- Visual Cue ph·∫£i m√¥ t·∫£ h√†nh ƒë·ªông c·ª• th·ªÉ, d·ªÖ h√¨nh dung (v√≠ d·ª•: "C·∫≠n c·∫£nh texture kem tan tr√™n da", "Bi·ªÉu c·∫£m nhƒÉn m·∫∑t khi...")
- Headline ph·∫£i l·ªìng gh√©p kh√©o l√©o USP (n·∫øu c√≥) v√†o gi·∫£i ph√°p ho·∫∑c v·∫•n ƒë·ªÅ
- Ng√¥n ng·ªØ: Ti·∫øng Vi·ªát t·ª± nhi√™n, b·∫Øt trend n·∫øu ph√π h·ª£p v·ªõi nh√≥m kh√°ch h√†ng tr·∫ª
- T·∫°o 3 hooks cho m·ªói lo·∫°i (Negative Warning, Secret Reveal, Transformation) cho m·ªói platform
- Output PH·∫¢I l√† JSON valid, kh√¥ng c√≥ markdown`;

    try {
        onProgress?.('Ph√¢n t√≠ch Pain Point & Desire...');

        const userPrompt = `TOPIC / S·∫¢N PH·∫®M: ${input.topic}
TARGET AUDIENCE: ${input.targetAudience}
${input.usp ? `USP / FEATURES: ${input.usp}` : ''}
${input.platform ? `PLATFORM: ${input.platform}` : ''}

H√£y √°p d·ª•ng The Hook Matrix ƒë·ªÉ t·∫°o hooks theo 3 lo·∫°i ch√≠nh:
1. Negative Warning (C·∫£nh b√°o ti√™u c·ª±c)
2. Secret Reveal (Ti·∫øt l·ªô b√≠ m·∫≠t)
3. Transformation (S·ª± l·ªôt x√°c)

Nh·ªõ:
1. Ph√¢n t√≠ch Pain Point & Desire tr∆∞·ªõc
2. T·∫°o 3 hooks cho m·ªói lo·∫°i cho m·ªói platform
3. Video hooks PH·∫¢I c√≥ visual_cue chi ti·∫øt (m√¥ t·∫£ h√†nh ƒë·ªông c·ª• th·ªÉ trong 3 gi√¢y ƒë·∫ßu)
4. M·ªói hook ph·∫£i c√≥ psychology_trigger`;

        onProgress?.('√Åp d·ª•ng The Hook Matrix...');

        const response = await ai.models.generateContent({
            model: 'gemini-2.0-flash-exp',
            contents: userPrompt,
            config: {
                systemInstruction: systemPrompt,
                temperature: 0.85,
                safetySettings: SAFETY_SETTINGS,
                responseMimeType: 'application/json'
            },
        });

        onProgress?.('ƒêang t·∫°o hooks...');

        const text = response.text?.trim();
        if (!text) return null;

        const jsonStr = text.replace(/```json|```/g, '').trim();
        const result = JSON.parse(jsonStr) as HookGeneratorResult;

        return result;
    } catch (error) {
        console.error('Hook Generator Error:', error);
        return null;
    }
};
